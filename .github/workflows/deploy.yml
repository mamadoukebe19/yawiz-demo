name: Deploy Yawiz Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/serverweb.pem
        chmod 600 ~/.ssh/serverweb.pem
        ssh-keyscan -H ${{ secrets.SERVER_1_IP }} >> ~/.ssh/known_hosts
        ssh-keyscan -H ${{ secrets.SERVER_2_IP }} >> ~/.ssh/known_hosts

    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible

    - name: Create dynamic inventory
      run: |
        cat > hosts << EOF
        [targets]
        web-server-1 ansible_host=${{ secrets.SERVER_1_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/serverweb.pem
        web-server-2 ansible_host=${{ secrets.SERVER_2_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/serverweb.pem
        
        [targets:vars]
        ansible_ssh_common_args='-o StrictHostKeyChecking=no'
        EOF

    - name: Test connectivity
      run: ansible all -i hosts -m ping

    - name: Deploy application
      run: ansible-playbook -i hosts deploy_with_ansible.yml

    - name: Verify deployment
      run: |
        echo "ðŸŽ‰ Deployment completed!"
        echo "Application URLs:"
        echo "â€¢ http://${{ secrets.SERVER_1_IP }}"
        echo "â€¢ http://${{ secrets.SERVER_2_IP }}"